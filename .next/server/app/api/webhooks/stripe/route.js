(()=>{var e={};e.id=4024,e.ids=[4024],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},51906:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=51906,e.exports=t},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56621:(e,t,r)=>{"use strict";r.d(t,{z:()=>n});var s=r(34386);let n=()=>{let e="https://ufjfafcfkalaasdhgcbi.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmamZhZmNma2FsYWFzZGhnY2JpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MTQ3MTMsImV4cCI6MjA2MzI5MDcxM30.PzwQAeRUJDK8llZf0awLwgW6j-pAmZPOgz55USsOnyo";if(!e||!t)throw Error("Supabase environment variables not configured");return(0,s.createServerClient)(e,t,{cookies:{get:()=>null,set(){},remove(){}}})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},86051:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>k,routeModule:()=>w,serverHooks:()=>v,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>x});var s={};r.r(s),r.d(s,{POST:()=>p});var n=r(96559),o=r(48088),a=r(37719),i=r(32190),c=r(56621);let u=new(r(97877)).A(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-05-28.basil"}),d=process.env.STRIPE_WEBHOOK_SECRET;async function p(e){try{let t,r=await e.text(),s=e.headers.get("stripe-signature");try{t=u.webhooks.constructEvent(r,s,d)}catch(e){return console.error("❌ Webhook signature verification failed:",e),i.NextResponse.json({error:"Webhook signature verification failed"},{status:400})}switch(console.log("\uD83D\uDD14 Received Stripe webhook:",t.type),t.type){case"payment_intent.succeeded":await l(t.data.object);break;case"payment_intent.payment_failed":await m(t.data.object);break;case"invoice.payment_succeeded":await g(t.data.object);break;case"invoice.payment_failed":await _(t.data.object);break;case"customer.subscription.created":await y(t.data.object);break;case"customer.subscription.updated":await b(t.data.object);break;case"customer.subscription.deleted":await f(t.data.object);break;default:console.log(`🤷 Unhandled event type: ${t.type}`)}return i.NextResponse.json({received:!0})}catch(e){return console.error("❌ Webhook error:",e),i.NextResponse.json({error:"Webhook error"},{status:500})}}async function l(e){console.log("\uD83D\uDCB0 Payment succeeded:",e.id);let t=(0,c.z)(),{error:r}=await t.from("transactions").update({payment_status:"succeeded",stripe_charge_id:e.latest_charge,transacted_at:new Date().toISOString()}).eq("stripe_payment_intent_id",e.id);r?console.error("❌ Error updating transaction:",r):console.log("✅ Updated transaction status to succeeded")}async function m(e){console.log("❌ Payment failed:",e.id);let t=(0,c.z)(),{error:r}=await t.from("transactions").update({payment_status:"failed",notes:e.last_payment_error?.message||"Payment failed"}).eq("stripe_payment_intent_id",e.id);r?console.error("❌ Error updating failed transaction:",r):console.log("✅ Updated transaction status to failed")}async function g(e){console.log("\uD83D\uDCC4 Invoice payment succeeded:",e.id);let t=e.subscription;if(!t)return;let r=(0,c.z)(),s=(await u.subscriptions.retrieve(t)).metadata||{},n={contact_id:s.contact_id||null,amount:e.amount_paid/100,currency:e.currency.toUpperCase(),category:s.fund_designation||"General Fund",payment_method:"Stripe (Recurring)",payment_status:"succeeded",transacted_at:new Date().toISOString(),stripe_invoice_id:e.id,stripe_subscription_id:t,stripe_customer_id:e.customer,is_recurring:!0,is_anonymous:!1,fund_designation:s.fund_designation||"General Fund",metadata:{frequency:s.frequency||"monthly",source:"church_website",type:"recurring_donation_payment",invoice_id:e.id}},{error:o}=await r.from("transactions").insert([n]);o?console.error("❌ Error creating recurring transaction:",o):console.log("✅ Created recurring transaction record")}async function _(e){console.log("❌ Invoice payment failed:",e.id)}async function y(e){console.log("\uD83D\uDD14 Subscription created:",e.id)}async function b(e){console.log("\uD83D\uDD04 Subscription updated:",e.id);let t=(0,c.z)(),{error:r}=await t.from("recurring_donations").update({status:e.status,next_payment_date:"active"===e.status?new Date(Date.now()+2592e6).toISOString():null}).eq("stripe_subscription_id",e.id);r?console.error("❌ Error updating recurring donation:",r):console.log("✅ Updated recurring donation status")}async function f(e){console.log("\uD83D\uDDD1️ Subscription deleted:",e.id);let t=(0,c.z)(),{error:r}=await t.from("recurring_donations").update({status:"cancelled",cancelled_at:new Date().toISOString()}).eq("stripe_subscription_id",e.id);r?console.error("❌ Error cancelling recurring donation:",r):console.log("✅ Cancelled recurring donation")}let w=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"/Users/nanasasu/docm-web-standalone/src/app/api/webhooks/stripe/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:h,workUnitAsyncStorage:x,serverHooks:v}=w;function k(){return(0,a.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:x})}},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4447,9398,4386,580,7877],()=>r(86051));module.exports=s})();