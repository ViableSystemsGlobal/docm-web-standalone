(()=>{var e={};e.id=6354,e.ids=[6354],e.modules={2452:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>f,routeModule:()=>l,serverHooks:()=>y,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>g});var n={};r.r(n),r.d(n,{POST:()=>p});var o=r(96559),s=r(48088),i=r(37719),a=r(32190),c=r(56621);let u=new(r(97877)).A(process.env.STRIPE_SECRET_KEY||"sk_test_51M3A4oL5sFi7cbV9iie5qzus9bF21F71csX8mUsLGYSwDRzr0nl34T8aH3QjFxyW7Cp4dQWLlWYqJ2je1fwiq9Xu0036EG9X4l",{apiVersion:"2025-05-28.basil"});async function d({contactId:e,amount:t,currency:r,fundDesignation:n,paymentMethod:o,isAnonymous:s,notes:i,stripePaymentIntentId:a,stripeCustomerId:u,isRecurring:d=!1,frequency:p="one-time"}){let l=(0,c.z)(),m={contact_id:e||null,amount:t,currency:r.toUpperCase(),category:n,payment_method:o,payment_status:"pending",transacted_at:new Date().toISOString(),notes:i||null,stripe_payment_intent_id:a||null,stripe_customer_id:u||null,is_anonymous:s,is_recurring:d,fund_designation:n,metadata:{frequency:p,source:"church_website",type:d?"recurring_donation":"one_time_donation"}};console.log("\uD83D\uDCBE Creating transaction record:",m);let{data:g,error:y}=await l.from("transactions").insert([m]).select().single();if(y)throw console.error("❌ Error creating transaction record:",y),Error(`Failed to create transaction record: ${y.message}`);return console.log("✅ Created transaction record:",g.id),g}async function p(e){try{let t,r,{amount:n,currency:o="usd",fundDesignation:s="General",isAnonymous:i=!1,notes:p,donorEmail:l,donorName:m,frequency:g="one-time"}=await e.json();if(console.log("\uD83D\uDCB0 Processing donation request:",{amount:n,frequency:g,fundDesignation:s,donorEmail:l,isAnonymous:i}),!n||n<=0)return a.NextResponse.json({error:"Valid amount is required"},{status:400});if(!l&&!i)return a.NextResponse.json({error:"Email is required for non-anonymous donations"},{status:400});if(!i&&l){let e=(0,c.z)(),{data:n}=await e.from("contacts").select("id").eq("email",l).single();if(n)t=n.id,console.log("\uD83D\uDCE7 Found existing contact:",t);else if(m){let[r,...n]=m.split(" "),o=n.join(" "),{data:s,error:i}=await e.from("contacts").insert([{first_name:r,last_name:o||"",email:l,phone:"",source:"online_donation"}]).select().single();!i&&s&&(t=s.id,console.log("\uD83D\uDC64 Created new contact:",t))}try{let e=await u.customers.list({email:l,limit:1});e.data.length>0?(r=e.data[0].id,console.log("\uD83D\uDCB3 Found existing Stripe customer:",r)):(r=(await u.customers.create({email:l,name:m,metadata:{contact_id:t||"",source:"church_website"}})).id,console.log("\uD83C\uDD95 Created new Stripe customer:",r))}catch(e){return console.error("❌ Failed to create/retrieve Stripe customer:",e),a.NextResponse.json({error:"Failed to set up customer account"},{status:500})}}if("one-time"!==g){if(console.log("\uD83D\uDD04 Processing recurring donation..."),!r)return console.error("❌ Customer required for recurring donations"),a.NextResponse.json({error:"Customer required for recurring donations"},{status:400});try{console.log("\uD83D\uDCDD Creating price for recurring donation...",{amount:Math.round(100*n),currency:o,interval:"weekly"===g?"week":"month"});let e=await u.prices.create({unit_amount:Math.round(100*n),currency:o.toLowerCase(),recurring:{interval:"weekly"===g?"week":"month",interval_count:1},product_data:{name:`Recurring Donation - ${s}`},metadata:{fund_designation:s,type:"recurring_donation"}});console.log("✅ Created price:",e.id),console.log("\uD83D\uDD14 Creating subscription...",{customer:r,priceId:e.id});let c=await u.setupIntents.create({customer:r,metadata:{contact_id:t||"",fund_designation:s,type:"recurring_donation_setup",frequency:g,amount:n.toString(),price_id:e.id},usage:"off_session"});return console.log("✅ Created setup intent for recurring donation:",c.id),await d({contactId:t,amount:n,currency:o,fundDesignation:s,paymentMethod:"Stripe (Recurring)",isAnonymous:i,notes:p,stripeCustomerId:r,isRecurring:!0,frequency:g}),a.NextResponse.json({setupIntentId:c.id,clientSecret:c.client_secret,priceId:e.id,type:"recurring"})}catch(e){return console.error("❌ Error creating recurring donation:",e),console.error("Error details:",{message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0,type:typeof e,customerId:r,amount:n,frequency:g}),a.NextResponse.json({error:"Failed to create recurring donation",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}console.log("\uD83D\uDCB3 Processing one-time donation...");try{let e=await u.paymentIntents.create({amount:Math.round(100*n),currency:o.toLowerCase(),customer:r,metadata:{contact_id:t||"",fund_designation:s,is_anonymous:i.toString(),notes:p||"",category:s,type:"donation",frequency:"one-time"},description:`Donation to ${s}`,statement_descriptor:"CHURCH DONATION",receipt_email:i?void 0:l});return console.log("✅ Created one-time payment intent:",e.id),await d({contactId:t,amount:n,currency:o,fundDesignation:s,paymentMethod:"Stripe",isAnonymous:i,notes:p,stripePaymentIntentId:e.id,stripeCustomerId:r,isRecurring:!1,frequency:g}),a.NextResponse.json({clientSecret:e.client_secret,paymentIntentId:e.id})}catch(e){return console.error("❌ Error creating payment intent:",e),a.NextResponse.json({error:"Failed to create payment intent"},{status:500})}}catch(e){return console.error("❌ Error creating payment intent:",e),a.NextResponse.json({error:"Internal server error"},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/donations/create-payment-intent/route",pathname:"/api/donations/create-payment-intent",filename:"route",bundlePath:"app/api/donations/create-payment-intent/route"},resolvedPagePath:"/Users/nanasasu/docm-web-standalone/src/app/api/donations/create-payment-intent/route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:m,workUnitAsyncStorage:g,serverHooks:y}=l;function f(){return(0,i.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:g})}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},51906:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=51906,e.exports=t},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56621:(e,t,r)=>{"use strict";r.d(t,{z:()=>o});var n=r(34386);let o=()=>{let e="https://ufjfafcfkalaasdhgcbi.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmamZhZmNma2FsYWFzZGhnY2JpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MTQ3MTMsImV4cCI6MjA2MzI5MDcxM30.PzwQAeRUJDK8llZf0awLwgW6j-pAmZPOgz55USsOnyo";if(!e||!t)throw Error("Supabase environment variables not configured");return(0,n.createServerClient)(e,t,{cookies:{get:()=>null,set(){},remove(){}}})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[4447,9398,4386,580,7877],()=>r(2452));module.exports=n})();