(()=>{var e={};e.id=6492,e.ids=[6492],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},51906:e=>{function r(e){var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=51906,e.exports=r},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56621:(e,r,t)=>{"use strict";t.d(r,{z:()=>i});var s=t(34386);let i=()=>{let e="https://ufjfafcfkalaasdhgcbi.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmamZhZmNma2FsYWFzZGhnY2JpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MTQ3MTMsImV4cCI6MjA2MzI5MDcxM30.PzwQAeRUJDK8llZf0awLwgW6j-pAmZPOgz55USsOnyo";if(!e||!r)throw Error("Supabase environment variables not configured");return(0,s.createServerClient)(e,r,{cookies:{get:()=>null,set(){},remove(){}}})}},62726:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>_,routeModule:()=>p,serverHooks:()=>g,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>m});var s={};t.r(s),t.d(s,{POST:()=>d});var i=t(96559),n=t(48088),o=t(37719),a=t(32190),u=t(56621);let c=new(t(97877)).A(process.env.STRIPE_SECRET_KEY||"sk_test_51M3A4oL5sFi7cbV9iie5qzus9bF21F71csX8mUsLGYSwDRzr0nl34T8aH3QjFxyW7Cp4dQWLlWYqJ2je1fwiq9Xu0036EG9X4l",{apiVersion:"2025-05-28.basil"});async function d(e){try{let{setupIntentId:r}=await e.json();if(console.log("\uD83D\uDD04 Confirming recurring donation setup:",r),!r)return a.NextResponse.json({error:"Setup intent ID is required"},{status:400});let t=await c.setupIntents.retrieve(r);if("succeeded"!==t.status)return a.NextResponse.json({error:"Setup intent not confirmed"},{status:400});let s=t.metadata||{},i=t.customer,n=t.payment_method,o=s.price_id,d=s.contact_id,p=s.fund_designation||"General Fund",l=s.frequency||"monthly",m=parseFloat(s.amount||"0"),g=await c.subscriptions.create({customer:i,items:[{price:o}],default_payment_method:n,metadata:{contact_id:d,fund_designation:p,type:"recurring_donation",frequency:l,setup_intent_id:r},description:`Recurring donation to ${p}`});console.log("✅ Created subscription:",g.id);let _=(0,u.z)(),{data:f,error:x}=await _.from("transactions").select("id").eq("stripe_customer_id",i).eq("amount",m).eq("is_recurring",!0).eq("payment_status","pending").order("created_at",{ascending:!1}).limit(1).single();if(x)console.error("❌ Error finding transaction record:",x);else if(f){let{error:e}=await _.from("transactions").update({payment_status:"active",stripe_subscription_id:g.id,metadata:{frequency:l,source:"church_website",type:"recurring_donation",setup_intent_id:r,subscription_id:g.id}}).eq("id",f.id);e?console.error("❌ Error updating transaction record:",e):console.log("✅ Updated transaction record with subscription details")}let w={contact_id:d||null,stripe_subscription_id:g.id,amount:m,currency:"USD",interval_type:"weekly"===l?"week":"month",interval_count:1,fund_designation:p,status:"active",started_at:new Date().toISOString(),next_payment_date:new Date(Date.now()+("weekly"===l?7:30)*864e5).toISOString()},{error:q}=await _.from("recurring_donations").upsert(w,{onConflict:"stripe_subscription_id",ignoreDuplicates:!1});return q?console.error("❌ Error creating/updating recurring donation record:",q):console.log("✅ Created/updated recurring donation record"),a.NextResponse.json({success:!0,subscriptionId:g.id,message:"Recurring donation confirmed successfully"})}catch(e){return console.error("❌ Error confirming recurring donation:",e),a.NextResponse.json({error:"Failed to confirm recurring donation"},{status:500})}}let p=new i.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/donations/confirm-recurring/route",pathname:"/api/donations/confirm-recurring",filename:"route",bundlePath:"app/api/donations/confirm-recurring/route"},resolvedPagePath:"/Users/nanasasu/docm-web-standalone/src/app/api/donations/confirm-recurring/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:l,workUnitAsyncStorage:m,serverHooks:g}=p;function _(){return(0,o.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:m})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4447,9398,4386,580,7877],()=>t(62726));module.exports=s})();